name: "Setup AWS"
description: "Configures AWS credentials and launches an EC2 instance"
inputs:
  aws_access_key_id:
    description: "AWS Access Key ID"
    required: true
  aws_secret_access_key:
    description: "AWS Secret Access Key"
    required: true
outputs:
  instance_ip:
    description: "EC2 Instance IP"
    value: ${{ steps.set-instance.outputs.instance_ip }}
  instance_id:
    description: "EC2 Instance ID"
    value: ${{ steps.set-instance.outputs.instance_id }}

runs:
  using: "composite"
  steps:
    - name: Configure AWS Credentials
      run: |
        aws configure set aws_access_key_id ${{ inputs.aws_access_key_id }}
        aws configure set aws_secret_access_key ${{ inputs.aws_secret_access_key }}
        aws configure set region us-east-1
      shell: bash

    - name: Check AWS CLI Version
      id: check-aws-cli
      run: |
        if aws --version; then
          echo "AWS CLI is already installed."
        else
          echo "AWS CLI is missing. Installing now..."
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version
        fi
      shell: bash

    - name: Launch EC2 Instance
      id: set-instance
      run: |
        INSTANCE_ID=$(aws ec2 run-instances --image-id ami-0f9de6e2d2f067fca \
          --instance-type t3.micro --key-name new-key \
          --security-group-ids sg-04b81fc613de74b2a \
          --query "Instances[0].InstanceId" --output text)
        INSTANCE_IP=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
        echo "INSTANCE_IP=$INSTANCE_IP" >> $GITHUB_ENV
        echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
      shell: bash

    - name: Wait for EC2 Instance to Start
      run: aws ec2 wait instance-running --instance-ids $INSTANCE_ID
      shell: bash

    - name: Ensure EC2 Instance Is Fully Initialized
      run: |
        while true; do
          INSTANCE_STATE=$(aws ec2 describe-instance-status --instance-ids $INSTANCE_ID --query "InstanceStatuses[0].InstanceState.Name" --output text)
          SYSTEM_STATUS=$(aws ec2 describe-instance-status --instance-ids $INSTANCE_ID --query "InstanceStatuses[0].SystemStatus.Status" --output text)
          INSTANCE_STATUS=$(aws ec2 describe-instance-status --instance-ids $INSTANCE_ID --query "InstanceStatuses[0].InstanceStatus.Status" --output text)
          echo "Current State: $INSTANCE_STATE | System Status: $SYSTEM_STATUS | Instance Status: $INSTANCE_STATUS"
          if [[ "$INSTANCE_STATE" == "running" && "$SYSTEM_STATUS" == "ok" && "$INSTANCE_STATUS" == "ok" ]]; then
            echo "Instance is fully initialized!"
            break
          fi
          sleep 10
        done
      shell: bash
